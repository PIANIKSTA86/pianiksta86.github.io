/**
 * API.JS - Capa de comunicaci√≥n con Google Apps Script
 * 
 * Reemplaza google.script.run para una arquitectura desacoplada
 * Backend en Apps Script + Frontend en GitHub Pages
 */

class GilsaAPI {
  constructor() {
    this.baseUrl = CONFIG.API_URL;
    this.maxRetries = CONFIG.MAX_RETRIES;
    this.retryDelay = CONFIG.RETRY_DELAY;
    this.timeout = CONFIG.REQUEST_TIMEOUT;
  }

  /**
   * Realiza una llamada POST al API de Apps Script
   * @param {string} action - Nombre de la funci√≥n en Code.gs
   * @param {*} payload - Datos a enviar
   * @param {Function} onSuccess - Callback de √©xito
   * @param {Function} onError - Callback de error
   */
  async call(action, payload = null, onSuccess = null, onError = null) {
    try {
      if (CONFIG.DEBUG) {
        console.log(`üì§ API Call: ${action}`, payload);
      }

      const response = await this._fetchWithRetry({
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          action: action,
          payload: payload
        })
      });

      if (CONFIG.DEBUG) {
        console.log(`üì• API Response (${action}):`, response);
      }

      if (!response.success) {
        throw new Error(response.error || 'Error desconocido en el API');
      }

      if (onSuccess) {
        onSuccess(response.data);
      }

      return response.data;

    } catch (error) {
      console.error(`‚ùå Error en API.${action}:`, error);
      
      if (onError) {
        onError(error.message);
      } else {
        this._showErrorNotification(error.message);
      }
      
      throw error;
    }
  }

  /**
   * Fetch con reintentos autom√°ticos
   */
  async _fetchWithRetry(options) {
    let lastError;

    for (let attempt = 1; attempt <= this.maxRetries; attempt++) {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), this.timeout);

        const response = await fetch(this.baseUrl, {
          ...options,
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        return await response.json();

      } catch (error) {
        lastError = error;
        
        if (attempt < this.maxRetries) {
          console.warn(`‚ö†Ô∏è Intento ${attempt}/${this.maxRetries} fall√≥. Reintentando en ${this.retryDelay}ms...`);
          await this._sleep(this.retryDelay);
        }
      }
    }

    throw lastError;
  }

  /**
   * Utilidades
   */
  _sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  _showErrorNotification(message) {
    alert(`‚ùå Error: ${message}`);
  }

  /**
   * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
   * M√âTODOS ESPEC√çFICOS DEL NEGOCIO                                ‚ïë
   * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
   */

  /**
   * Buscar cliente por ID
   */
  buscarClientePorId(idCliente) {
    return this.call('buscarClientePorId', { idCliente });
  }

  /**
   * Listar vendedores disponibles
   */
  listarVendedores() {
    return this.call('listarVendedores', null);
  }

  /**
   * Buscar producto por c√≥digo
   */
  buscarProductoPorCodigo(codigo, tipoPrecio) {
    return this.call('buscarProductoPorCodigo', { codigo, tipoPrecio });
  }

  /**
   * Guardar pedido completo
   */
  guardarPedido(data) {
    return this.call('guardarPedido', data);
  }

  /**
   * Generar PDF del pedido
   */
  generarPDFPedido(idPedido) {
    return this.call('generarPDFPedido', { idPedido });
  }

  /**
   * Obtener estad√≠sticas de control (para debugging)
   */
  obtenerEstadisticasControl() {
    return this.call('obtenerEstadisticasControl', null);
  }
}

/**
 * Instancia global del API
 * Uso: api.buscarClientePorId('C001').then(cliente => {...})
 */
const api = new GilsaAPI();

/**
 * Compatibilidad: Wrapper similar a google.script.run
 * Uso: withSuccessHandler(callback).buscarClientePorId('C001')
 */
const withSuccessHandler = (successCallback) => ({
  buscarClientePorId: async (id) => {
    try {
      const result = await api.buscarClientePorId(id);
      successCallback(result);
    } catch (e) {
      console.error(e);
    }
  },
  listarVendedores: async () => {
    try {
      const result = await api.listarVendedores();
      successCallback(result);
    } catch (e) {
      console.error(e);
    }
  },
  buscarProductoPorCodigo: async (codigo, tipoPrecio) => {
    try {
      const result = await api.buscarProductoPorCodigo(codigo, tipoPrecio);
      successCallback(result);
    } catch (e) {
      console.error(e);
    }
  },
  guardarPedido: async (data) => {
    try {
      const result = await api.guardarPedido(data);
      successCallback(result);
    } catch (e) {
      console.error(e);
    }
  },
  generarPDFPedido: async (idPedido) => {
    try {
      const result = await api.generarPDFPedido(idPedido);
      successCallback(result);
    } catch (e) {
      console.error(e);
    }
  },
  obtenerEstadisticasControl: async () => {
    try {
      const result = await api.obtenerEstadisticasControl();
      successCallback(result);
    } catch (e) {
      console.error(e);
    }
  }
});

// Para compatibilidad: google.script.run simulado
const google = {
  script: {
    run: {
      withSuccessHandler: withSuccessHandler
    }
  }
};
